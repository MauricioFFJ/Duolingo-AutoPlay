name: Estudo DiÃ¡rio VariÃ¡vel

on:
  schedule:
    - cron: '0 9 * * *'  # Executa uma vez por dia (Ã s 6h da manhÃ£ no Brasil)
  workflow_dispatch:

jobs:
  preparar-estudo:
    runs-on: ubuntu-latest
    outputs:
      total_lessons: ${{ steps.sortear-lessons.outputs.total_lessons }}
    steps:
      - name: Sortear total de liÃ§Ãµes do dia
        id: sortear-lessons
        run: |
          TOTAL_LESSONS=$(( (RANDOM % 22) + 7 ))  # 7 a 28 liÃ§Ãµes â†’ 70 a 280 XP
          echo "Total de liÃ§Ãµes do dia: $TOTAL_LESSONS"
          echo "total_lessons=$TOTAL_LESSONS" >> $GITHUB_OUTPUT

      - name: Salvar total em arquivo
        run: |
          echo "${{ steps.sortear-lessons.outputs.total_lessons }}" > total_lessons.txt
          echo "0" > liÃ§Ãµes_consumidas.txt
          git config --global user.name "duobot"
          git config --global user.email "duobot@example.com"
          git add total_lessons.txt liÃ§Ãµes_consumidas.txt
          git commit -m "Total de liÃ§Ãµes do dia definido"
          git push

  executar-estudo:
    needs: preparar-estudo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        execucao: [1, 2, 3, 4]  # AtÃ© 4 execuÃ§Ãµes por dia
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v3

      - name: Sortear atraso aleatÃ³rio
        run: |
          DELAY=$((RANDOM % 180))  # AtÃ© 3 horas de atraso
          echo "Aguardando $DELAY minutos..."
          sleep "${DELAY}m"

      - name: Ler total de liÃ§Ãµes do dia
        run: |
          TOTAL=$(cat total_lessons.txt)
          echo "TOTAL_LESSONS=$TOTAL" >> $GITHUB_ENV

      - name: Calcular liÃ§Ãµes desta execuÃ§Ã£o
        run: |
          CONSUMIDAS=$(cat liÃ§Ãµes_consumidas.txt 2>/dev/null || echo 0)
          RESTANTES=$((TOTAL_LESSONS - CONSUMIDAS))

          if [ "$RESTANTES" -le 0 ]; then
            echo "Nada a estudar hoje ðŸŽ‰"
            exit 0
          fi

          # Sorteia entre 2 e 8 liÃ§Ãµes, sem ultrapassar o restante
          MAX=$(( RESTANTES < 8 ? RESTANTES : 8 ))
          LIÃ‡Ã•ES=$(( (RANDOM % (MAX - 1 + 1)) + 2 ))
          echo "LIÃ‡Ã•ES=$LIÃ‡Ã•ES" >> $GITHUB_ENV
          echo "LiÃ§Ãµes desta execuÃ§Ã£o: $LIÃ‡Ã•ES"

      - name: Atualizar progresso
        run: |
          XP=$(($LIÃ‡Ã•ES * 10))
          echo "$(date -u) - $XP XP ganhos (${LIÃ‡Ã•ES} liÃ§Ãµes)" >> xp-log.txt

          CONSUMIDAS=$(cat liÃ§Ãµes_consumidas.txt 2>/dev/null || echo 0)
          NOVO_TOTAL=$((CONSUMIDAS + LIÃ‡Ã•ES))
          echo "$NOVO_TOTAL" > liÃ§Ãµes_consumidas.txt

          git config --global user.name "duobot"
          git config --global user.email "duobot@example.com"
          git add xp-log.txt liÃ§Ãµes_consumidas.txt
          git commit -m "Estudo registrado: $XP XP ganhos"
          git push
